<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reset Password</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family: system-ui, sans-serif; }
    body { background:#f5f5f5; display:flex; justify-content:center; align-items:center; min-height:100vh; padding:20px; }
    .container { background:#fff; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,.1); width:100%; max-width:450px; padding:30px; }
    .logo { text-align:center; margin-bottom:30px; }
    .logo h1 { color:#2563eb; font-size:28px; font-weight:700; }
    .progress-bar { display:flex; justify-content:space-between; margin-bottom:30px; position:relative; }
    .progress-bar::before { content:''; position:absolute; top:50%; left:0; right:0; height:2px; background:#e5e7eb; transform:translateY(-50%); z-index:1; }
    .progress-step { width:30px; height:30px; border-radius:50%; background:white; border:2px solid #e5e7eb; display:flex; align-items:center; justify-content:center; font-weight:600; color:#6b7280; position:relative; z-index:2; }
    .progress-step.active { background:#2563eb; border-color:#2563eb; color:white; }
    .progress-step.completed { background:#10b981; border-color:#10b981; color:white; }
    .step { display:none; }
    .step.active { display:block; }
    h2 { color:#1f2937; margin-bottom:20px; font-size:24px; text-align:center; }
    .form-group { margin-bottom:20px; }
    label { display:block; margin-bottom:8px; color:#374151; font-weight:500; }
    input { width:100%; padding:12px 16px; border:2px solid #e5e7eb; border-radius:8px; font-size:16px; transition:border-color .2s; }
    input:focus { outline:none; border-color:#2563eb; }
    .error { background:#fee2e2; color:#b91c1c; font-size:14px; padding:8px; border-radius:6px; margin-top:8px; display:none; }
    .success { background:#dcfce7; color:#15803d; font-size:14px; padding:8px; border-radius:6px; margin-top:8px; display:none; }
    .btn { width:100%; padding:14px; background:#2563eb; color:white; border:none; border-radius:8px; font-size:16px; font-weight:600; cursor:pointer; transition:background .2s; }
    .btn:hover { background:#1d4ed8; }
    .resend-otp { text-align:center; margin-top:20px; color:#6b7280; }
    .resend-otp a { color:#2563eb; text-decoration:none; cursor:pointer; }
    .resend-otp a:hover { text-decoration:underline; }
    .success-icon { text-align:center; font-size:64px; color:#10b981; margin-bottom:20px; }
    .success-message { text-align:center; color:#374151; line-height:1.6; }
    .password-wrapper { position:relative; }
    .password-wrapper input { padding-right:40px; }
    .toggle-password { position:absolute; top:50%; right:12px; transform:translateY(-50%); cursor:pointer; color:#6b7280; font-size:18px; }
    @media(max-width:480px){ .container{padding:20px;} h2{font-size:20px;} }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo"><h1>Account Recovery</h1></div>

    <div class="progress-bar">
      <div class="progress-step active">1</div>
      <div class="progress-step">2</div>
      <div class="progress-step">3</div>
      <div class="progress-step">4</div>
    </div>

    <!-- Step 1 -->
    <div class="step active" id="step1">
      <h2>Enter Your Email</h2>
      <div class="form-group">
        <label for="email">Email Address</label>
        <input type="email" id="email" placeholder="Enter your email address" required>
        <div class="error" id="email-error">Please enter a valid email address</div>
        <div class="success" id="email-success">Please check your Inbox/Spam folder for the OTP.</div>
      </div>
      <button class="btn" onclick="sendEmail()">Send Verification Code</button>
    </div>

    <!-- Step 2 -->
    <div class="step" id="step2">
      <h2>Verify Your Identity</h2>
      <div class="form-group">
        <label for="otp">Verification Code</label>
        <input type="text" id="otp" placeholder="Enter 6-digit code" maxlength="6" required>
        <div class="error" id="otp-error">Invalid OTP</div>
      </div>
      <button class="btn" onclick="verifyOTP()">Verify Code</button>
      <div class="resend-otp">Didn't receive the code? <a onclick="resendOTP()">Resend</a></div>
    </div>

    <!-- Step 3 -->
    <div class="step" id="step3">
      <h2>Create New Password</h2>
      <div class="form-group password-wrapper">
        <label for="newPassword">New Password</label>
        <input type="password" id="newPassword" placeholder="Enter new password" required>
        <i class="fa-solid fa-eye toggle-password" onclick="togglePassword('newPassword', this)"></i>
        <div class="error" id="password-error">Password must be at least 8 characters</div>
      </div>
      <div class="form-group password-wrapper">
        <label for="confirmPassword">Confirm Password</label>
        <input type="password" id="confirmPassword" placeholder="Confirm new password" required>
        <i class="fa-solid fa-eye toggle-password" onclick="togglePassword('confirmPassword', this)"></i>
        <div class="error" id="confirm-error">Passwords do not match</div>
      </div>
      <button class="btn" onclick="resetPassword()">Reset Password</button>
    </div>

    <!-- Step 4 -->
    <div class="step" id="step4">
      <div class="success-icon">✓</div>
      <h2>Password Reset Successful!</h2>
      <div class="success-message">
        Your password has been successfully reset. You can now login with your new password.
      </div>
      <button class="btn" style="margin-top: 20px;" onclick="goToLogin()">Go to Login</button>
    </div>
  </div>

  <script>
    const BASE_URL = window.location.origin;  // ✅ Works both local & Render
    let currentStep = 1;
    let userEmail = "";

    function updateProgressBar() {
      document.querySelectorAll('.progress-step').forEach((step, index) => {
        step.classList.remove('active','completed');
        if(index+1 < currentStep) step.classList.add('completed');
        else if(index+1 === currentStep) step.classList.add('active');
      });
    }

    function goToStep(step) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById(`step${step}`).classList.add('active');
      currentStep = step;
      updateProgressBar();
    }

    async function sendEmail() {
      userEmail = document.getElementById('email').value.trim();
      if(!userEmail.includes('@')) { 
        document.getElementById('email-error').style.display='block'; 
        return;
      }
      document.getElementById('email-error').style.display='none';

      try {
        const res = await fetch(`${BASE_URL}/forgot_password`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({email:userEmail})
        });
        const data = await res.json();
        if(data.success){ 
          document.getElementById('email-success').style.display='block';
          goToStep(2);
        } else {
          alert(data.message);
        }
      } catch (err) {
        alert("❌ Network or server error while sending OTP.");
      }
    }

    async function verifyOTP() {
      const otp = document.getElementById('otp').value.trim();
      const res = await fetch(`${BASE_URL}/verify_otp`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({email:userEmail, otp:otp})
      });
      const data = await res.json();
      if(data.success){ 
        document.getElementById('otp-error').style.display='none';
        goToStep(3); 
      } else { 
        document.getElementById('otp-error').style.display='block';
      }
    }

    async function resetPassword() {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      if(newPassword.length<8 || newPassword!==confirmPassword){ 
        document.getElementById('password-error').style.display=newPassword.length<8?'block':'none';
        document.getElementById('confirm-error').style.display=newPassword!==confirmPassword?'block':'none';
        return;
      }
      const res = await fetch(`${BASE_URL}/reset_password`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({email:userEmail, new_password:newPassword})
      });
      const data = await res.json();
      if(data.success){ goToStep(4); }
      else { alert(data.message); }
    }

    function resendOTP(){ sendEmail(); }
    function goToLogin(){ window.location.href="/login"; }

    function togglePassword(fieldId, icon){
      const input = document.getElementById(fieldId);
      if(input.type==='password'){ input.type='text'; icon.classList.replace('fa-eye','fa-eye-slash'); }
      else{ input.type='password'; icon.classList.replace('fa-eye-slash','fa-eye'); }
    }

    updateProgressBar();
  </script>
</body>
</html>
