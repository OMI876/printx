<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Manage Orders - PrintX Admin</title>
  <!-- ✅ Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{margin:0;font-family:Segoe UI, Roboto, sans-serif;background:#f6f7fb;color:#2f3a4a}
    .layout{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    .sidebar{background:#fff;border-right:1px solid #e3e9f2;position:sticky;top:0;height:100vh;
             display:flex;flex-direction:column;padding:18px 14px;gap:18px}
    .brand{font-weight:bold;font-size:20px;text-align:center}
    .nav{display:flex;flex-direction:column;gap:6px}
    .nav a{padding:10px 14px;text-decoration:none;color:#2f3a4a;border-radius:8px;transition:.2s}
    .nav a:hover{background:#f1f4f9}
    .nav .active{background:#e3e9f2}
    .spacer{flex:1}
    .logout{color:#d77a7a;font-weight:bold}
    .main{padding:22px}
    table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff;border-radius:8px;overflow:hidden}
    th,td{padding:10px 14px;border-bottom:1px solid #e3e9f2;text-align:left}
    th{background:#f1f4f9;color:#6c7a89;font-size:12px;text-transform:uppercase}
    select{padding:6px;border-radius:6px;border:1px solid #ccc}
    button{padding:6px 10px;border:none;border-radius:6px;background:#2563eb;color:#fff;cursor:pointer}
    button:hover{background:#1d4ed8}
    .order-img{width:60px;height:60px;object-fit:cover;border-radius:6px;cursor:pointer}
    .img-preview{max-width:100%;border-radius:8px}
  </style>
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">PrintX Admin</div>
      <nav class="nav">
        <a href="/admin">Dashboard</a>
        <a href="/admin/users">Users</a>
        <a href="/admin/orders" class="active">Orders</a>
        <a href="/admin/returns">Returns/Exchange</a>
        <a href="/admin/cancelled">Cancelled Orders</a> 
        <a href="/admin/messages">Messages</a>
      </nav>
      <div class="spacer"></div>
      <nav class="nav">
        <a href="/logout" class="logout">Logout</a>
      </nav>
    </aside>

    <!-- Main content -->
    <main class="main">
      <h1>Manage Orders</h1>

      <!-- ✅ Toast Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="toast-container position-fixed bottom-0 end-0 p-3">
            {% for category, message in messages %}
              <div class="toast align-items-center text-bg-{{ 'success' if category == 'success' else 'danger' }} border-0 show" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                  <div class="toast-body">{{ message }}</div>
                  <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <!-- Orders Table -->
      <table>
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Amount</th>
            <th>Payment Method</th>
            <th>Payment Status</th>
            <th>Order Status</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          {% for order in orders %}
          <tr>
            <td>{{ order.order_id }}</td>
            <td>{{ order.customer }}</td>
            <td>₹{{ order.amount }}</td>

            <!-- Payment Method -->
            <td>
              {% if order.payment_method == "ONLINE" %}
                <span class="badge bg-primary">Online</span>
              {% elif order.payment_method == "COD" %}
                <span class="badge bg-warning text-dark">Cash on Delivery</span>
              {% endif %}
            </td>

            <!-- Payment Status -->
            <td>
              {% if order.payment_status == "SUCCESS" %}
                <span class="badge bg-success">Paid</span>
              {% elif order.payment_status == "COD PENDING" %}
                <span class="badge bg-warning text-dark">Pending COD</span>
              {% else %}
                <span class="badge bg-danger">{{ order.payment_status }}</span>
              {% endif %}
            </td>

            <!-- Order Status -->
            <td>
              <form method="POST" action="{{ url_for('admin_bp.update_order_status') }}">
                <input type="hidden" name="order_id" value="{{ order.order_id }}">
                <select name="status">
                  <option value="Pending" {% if order.order_status=='Pending' %}selected{% endif %}>Pending</option>
                  <option value="Packed" {% if order.order_status=='Packed' %}selected{% endif %}>Packed</option>
                  <option value="Out for Delivery" {% if order.order_status=='Out for Delivery' %}selected{% endif %}>Out for Delivery</option>
                  <option value="Delivered" {% if order.order_status=='Delivered' %}selected{% endif %}>Delivered</option>
                  <!-- ✅ Added New Options -->
                  <option value="Returned" {% if order.order_status=='Returned' %}selected{% endif %}>Returned</option>
                  <option value="Exchanged" {% if order.order_status=='Exchanged' %}selected{% endif %}>Exchanged</option>
                </select>
                <button type="submit">Update</button>
              </form>
            </td>

            <td>{{ order.created_at }}</td>

            <!-- ✅ Details Button -->
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="viewDetails('{{ order.order_id }}')">View</button>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="8">No orders found</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </main>
  </div>

  <!-- ✅ Order Details Modal -->
  <div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Order Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="orderContent">
          <p>Loading...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Image Preview Modal -->
  <div class="modal fade" id="imgModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <a id="imgDownload" href="#" download>
            <img id="imgPreview" class="img-preview" src="" alt="Preview">
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      var toastElList = [].slice.call(document.querySelectorAll('.toast'))
      toastElList.map(function (toastEl) {
        var toast = new bootstrap.Toast(toastEl, { delay: 4000 });
        toast.show();
      });
    });

    // ✅ Fetch order details
    function viewDetails(orderId) {
      fetch(`/admin/order/${orderId}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            document.getElementById("orderContent").innerHTML = `<p class="text-danger">${data.error}</p>`;
            document.getElementById("modalTitle").innerText = "Order Details";
          } else {
            document.getElementById("modalTitle").innerText = `Order #${data.order_id}`;
            let html = `
              <h6>Customer Info</h6>
              <p><b>Name:</b> ${data.customer_name}</p>
              <p><b>Email:</b> ${data.email}</p>
              <p><b>Phone:</b> ${data.phone || '-'}</p>
              <p><b>Address:</b> ${data.address}</p>

              <h6>Order Info</h6>
              <p><b>Date:</b> ${data.order_date}</p>
              <p><b>Payment:</b> ${data.payment_method} (${data.payment_status})</p>
              <p><b>Status:</b> ${data.order_status}</p>

              <h6 class="mt-3">Ordered Items</h6>
              <table class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Image</th>
                    <th>Product</th>
                    <th>Size</th>
                    <th>Border</th>
                    <th>Qty</th>
                    <th>Price</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.items.map(item => `
                    <tr>
                      <td>
                        ${item.image_path 
                          ? `<img src="/static/${item.image_path}" class="order-img" onclick="showImage('/static/${item.image_path}')">` 
                          : '-'}
                      </td>
                      <td>${item.product_name}</td>
                      <td>${item.size || '-'}</td>
                      <td>${item.border_color || '-'} / ${item.border_width || '-'}</td>
                      <td>${item.quantity}</td>
                      <td>₹${item.price}</td>
                    </tr>`).join('')}
                  <tr class="table-light">
                    <td colspan="5" class="text-end"><b>Total</b></td>
                    <td><b>₹${data.total}</b></td>
                  </tr>
                </tbody>
              </table>
            `;
            document.getElementById("orderContent").innerHTML = html;
          }
          var modal = new bootstrap.Modal(document.getElementById('orderModal'));
          modal.show();
        })
        .catch(err => {
          console.error("❌ Fetch error:", err);
          document.getElementById("orderContent").innerHTML = `<p class="text-danger">Error loading details</p>`;
          document.getElementById("modalTitle").innerText = "Order Details";
          var modal = new bootstrap.Modal(document.getElementById('orderModal'));
          modal.show();
        });
    }

    // ✅ Show big preview
    function showImage(url) {
      document.getElementById("imgPreview").src = url;
      document.getElementById("imgDownload").href = url;
      var modal = new bootstrap.Modal(document.getElementById('imgModal'));
      modal.show();
    }
  </script>
</body>
</html>
